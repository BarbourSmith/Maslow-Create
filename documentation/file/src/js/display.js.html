<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/js/display.js | canvas-template</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#js">js</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/BOM.js~BOMEntry.html">BOMEntry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/display.js~Display.html">Display</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/globalvariables.js~GlobalVariables.html">GlobalVariables</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/menu.js~Menu.html">Menu</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-extractBomTags">extractBomTags</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addOrDeletePorts">addOrDeletePorts</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GitHubModule">GitHubModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-globalVariables">globalVariables</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-menu">menu</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#js-molecules">js/molecules</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/BOM.js~AddBOMTag.html">AddBOMTag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/assembly.js~Assembly.html">Assembly</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/circle.js~Circle.html">Circle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/constant.js~Constant.html">Constant</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/difference.js~Difference.html">Difference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/equation.js~Equation.html">Equation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/extrude.js~Extrude.html">Extrude</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/gcode.js~Gcode.html">Gcode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/githubmolecule.js~GitHubMolecule.html">GitHubMolecule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/input.js~Input.html">Input</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/intersection.js~Intersection.html">Intersection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/molecule.js~Molecule.html">Molecule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/output.js~Output.html">Output</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/readme.js~Readme.html">Readme</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/rectangle.js~Rectangle.html">Rectangle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/regularPolygon.js~RegularPolygon.html">RegularPolygon</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/rotate.js~Rotate.html">Rotate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/scale.js~Scale.html">Scale</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/shrinkwrap.js~ShrinkWrap.html">ShrinkWrap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/stretch.js~Stretch.html">Stretch</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/tag.js~Tag.html">Tag</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/translate.js~Translate.html">Translate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/molecules/union.js~Union.html">Union</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#js-prototypes">js/prototypes</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/prototypes/atom.js~Atom.html">Atom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/prototypes/attachmentpoint.js~AttachmentPoint.html">AttachmentPoint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/js/prototypes/connector.js~Connector.html">Connector</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/js/display.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import GlobalVariables from &apos;./globalvariables&apos;
import * as THREE from &apos;three&apos;
import { TrackballControls } from &apos;three/examples/jsm/controls/TrackballControls.js&apos;

/**
 * This class handles writing to the 3D preview display
 */
export default class Display {
    /**
     * The constructor run to create the new display. It seems to run with each refresh which doesn&apos;t seem right to me.
     */
    constructor(){
        /** 
         * An array which contains the data to be respresented in 3D.
         * @type {array}
         */
        this.datasets = []
        /** 
         * An Flag to indicate if the grid on the XY plane should be displayed.
         * @type {boolean}
         */
        this.displayGrid = true
        /** 
         * Grid scale to keep track of zoom scale
         * @type {number}
         */
        this.gridScale = 5
        /** 
         * A flag to indicate if the axes should be displayed.
         * @type {boolean}
         */
        this.axesCheck = true
        /** 
         * A flag to indicate if the frame should be displayed in wire frame.
         * @type {boolean}
         */
        this.wireDisplay = false
        /** 
         * A threejs camera instance.
         * @type {object}
         */
        this.camera
        /** 
         * A three js controls instance.
         * @type {object}
         */
        this.controls
        /** 
         * A threejs scene instance.
         * @type {object}
         */
        this.scene
        /** 
         * A threejs renderer instance.
         * @type {object}
         */
        this.renderer
        /** 
         * An instance of the threejs mesh material.
         * @type {object}
         */
        this.threeMaterial
        /** 
         * The applied material type.
         * @type {object}
         */
        this.mesh
        /** 
         * The HTML div object targeted to add the display to.
         * @type {object}
         */
        this.targetDiv = document.getElementById(&apos;viewerContext&apos;)
        
        //Add the JSXCAD window
        /** 
         * The camera which controls how the scene is rendered.
         * @type {object}
         */
        this.camera = new THREE.PerspectiveCamera(27, window.innerWidth / window.innerHeight, 1, 10500);
        [this.camera.position.x, this.camera.position.y, this.camera.position.z] = [0, -30, 50]
        //
        /** 
         * The controls which let the user pan and zoom with the mouse.
         * @type {object}
         */
        this.controls = new TrackballControls(this.camera, this.targetDiv)
        this.controls.rotateSpeed = 4.0
        this.controls.zoomSpeed = 4.0
        this.controls.panSpeed = 2.0
        this.controls.noZoom = false
        this.controls.noPan = false
        this.controls.staticMoving = true
        this.controls.dynamicDampingFactor = 0.1
        this.controls.keys = [65, 83, 68]
        this.controls.addEventListener(&apos;change&apos;, () =&gt; { this.render() })
        //
        /** 
         * The threejs scene to which things should be added to show up on the display.
         * @type {object}
         */
        this.scene = new THREE.Scene()
        this.scene.background = new THREE.Color(0xB0AEB0)
        this.scene.add(this.camera)
        //
        var ambientLight = new THREE.AmbientLight(0x222222)
        this.scene.add(ambientLight)
        // var light1 = new THREE.PointLight(0xffffff, 0, 1);
        // camera.add(light1);
        var light2 = new THREE.DirectionalLight(0xffffff, 1)
        light2.position.set(1, 1, 1)
        this.camera.add(light2)

        //sets axes
        var axesHelper = new THREE.AxesHelper( 10 )
        this.scene.add(axesHelper)
        
        //
        /** 
         * The three js webGLRendere object which does the actual rendering to the screen.
         * @type {object}
         */

        this.renderer = new THREE.WebGLRenderer({ antialias: true })
        this.renderer.setPixelRatio(window.devicePixelRatio)
        this.targetDiv.appendChild(this.renderer.domElement)
        
        this.onWindowResize()

        this.targetDiv.addEventListener(&apos;mousedown&apos;, () =&gt; {
            if(!GlobalVariables.runMode){
                let sideBar = document.querySelector(&apos;.sideBar&apos;)
                while (sideBar.firstChild) {
                    sideBar.removeChild(sideBar.firstChild)
                }
                
                //Grid display html element
                var name = document.createElement(&apos;h1&apos;)
                name.textContent = &quot;3D View&quot;
                name.setAttribute(&apos;class&apos;,&apos;doc-title&apos;)
                sideBar.appendChild(name)

                var gridDiv = document.createElement(&apos;div&apos;)
                sideBar.appendChild(gridDiv)
                gridDiv.setAttribute(&apos;id&apos;, &apos;gridDiv&apos;)
                var gridCheck = document.createElement(&apos;input&apos;)
                gridDiv.appendChild(gridCheck)
                gridCheck.setAttribute(&apos;type&apos;, &apos;checkbox&apos;)
                gridCheck.setAttribute(&apos;id&apos;, &apos;gridCheck&apos;)
               
                if (this.displayGrid){
                    gridCheck.setAttribute(&apos;checked&apos;, &apos;true&apos;)
                }

                var gridCheckLabel = document.createElement(&apos;label&apos;)
                gridDiv.appendChild(gridCheckLabel)
                gridCheckLabel.setAttribute(&apos;for&apos;, &apos;gridCheck&apos;)
                gridCheckLabel.setAttribute(&apos;style&apos;, &apos;margin-right:1em;&apos;)
                gridCheckLabel.textContent= &quot;Grid&quot;

                gridCheck.addEventListener(&apos;change&apos;, event =&gt; {
                    if(event.target.checked){
                        this.scene.add( this.plane )
                        this.displayGrid = true
                    }
                    else{
                        this.scene.remove(this.plane)
                        this.displayGrid = false
                    }
                })

                //Axes Html

                var axesDiv = document.createElement(&apos;div&apos;)
                sideBar.appendChild(axesDiv)
                var axesCheck = document.createElement(&apos;input&apos;)
                axesDiv.appendChild(axesCheck)
                axesCheck.setAttribute(&apos;type&apos;, &apos;checkbox&apos;)
                axesCheck.setAttribute(&apos;id&apos;, &apos;axesCheck&apos;)
                
                if (this.axesCheck){
                    axesCheck.setAttribute(&apos;checked&apos;, &apos;true&apos;)
                }

                var axesCheckLabel = document.createElement(&apos;label&apos;)
                axesDiv.appendChild(axesCheckLabel)
                axesCheckLabel.setAttribute(&apos;for&apos;, &apos;axesCheck&apos;)
                axesCheckLabel.setAttribute(&apos;style&apos;, &apos;margin-right:1em;&apos;)
                axesCheckLabel.textContent= &quot;Axes&quot;

                axesCheck.addEventListener(&apos;change&apos;, event =&gt; {
                    if(event.target.checked){
                        this.scene.add( axesHelper)
                        this.axesCheck = true
                    }
                    else{
                        this.scene.remove( axesHelper )
                        this.axesCheck = false
                    }
                })

                //Wireframe HTML element

                var wireDiv = document.createElement(&apos;div&apos;)
                sideBar.appendChild(wireDiv)
                wireDiv.setAttribute(&apos;id&apos;, &apos;wireDiv&apos;)
                var wireCheck = document.createElement(&apos;input&apos;)
                wireDiv.appendChild(wireCheck)
                wireCheck.setAttribute(&apos;type&apos;, &apos;checkbox&apos;)
                wireCheck.setAttribute(&apos;id&apos;, &apos;wireCheck&apos;)
               
                if (this.wireDisplay){
                    wireCheck.setAttribute(&apos;checked&apos;, &apos;true&apos;)
                    this.threeMaterial.wireframe = true
                }
                //wireCheck.setAttribute(&apos;checked&apos;, false)
                var wireCheckLabel = document.createElement(&apos;label&apos;)
                wireDiv.appendChild(wireCheckLabel)
                wireCheckLabel.setAttribute(&apos;for&apos;, &apos;wireCheck&apos;)
                wireCheckLabel.setAttribute(&apos;style&apos;, &apos;margin-right:10em;&apos;)
                wireCheckLabel.textContent= &quot;Wireframe&quot;

                wireCheck.addEventListener(&apos;change&apos;, event =&gt; {
                    if( event.target.checked){
                        this.threeMaterial.wireframe = true
                        this.wireDisplay = true
                    }
                    else{
                        this.threeMaterial.wireframe = false
                        this.wireDisplay = false
                    }
                })
            }
        })
        
        // This event listener adjusts the gridScale when you zoom in and out
        
        this.targetDiv.addEventListener(&apos;wheel&apos;, () =&gt;{ 
            
            if((this.dist3D(this.camera.position)/this.gridScale) &gt; 5){
                //this.scene.remove(this.plane)
                this.gridScale = Math.pow(5,this.baseLog(this.dist3D(this.camera.position),5))
                this.resizeGrid()
            }
            else if((this.dist3D(this.camera.position)/this.gridScale) &lt; .5){ 
                //this.scene.remove(this.plane)
                this.gridScale = Math.pow(5,this.baseLog(this.dist3D(this.camera.position),5))
                this.resizeGrid()
            }    
        })
    }
    /**
     * This function is intended to calculate the base log of two numbers and round it to an integer
     * @param {number,number}
     */ 
    baseLog(x,y){
        let baseLog = (Math.round(Math.log(x)/Math.log(y)))
        return baseLog
    }

    /**
     * This function is intended to calculate the 3d distance between object and camera
     * @param {number}
     */ 
    dist3D(position){
        const distance3D = Math.sqrt(Math.pow(position.x,2)
                         + Math.pow(position.y,2)
                         + Math.pow(position.z,2))
        return distance3D
    }
    
    /**
     * This function is intended to allow for materials. It is currently not used and can probably be deleted.
     * @param {object} material - A string to define the material type.
     */ 
    makeMaterial(material){
        switch (material) {
        case &apos;metal&apos;:
            return new THREE.MeshStandardMaterial({
                color: 0x779aac,
                emissive: 0x7090a0,
                roughness: 0.65,
                metalness: 0.99,
            })
        default:
            return new THREE.MeshNormalMaterial()
        }
    }
    
    /**
     * Writes a shape to the 3D display. Expecting a threejs geometry.
     * @param {object} shape - A jsxcad geometry data set to write to the display. Computation is done in a worker thread
     */ 
    writeToDisplay(shape){
        if(shape != null){
            const computeValue = async () =&gt; {
                try {
                    return await GlobalVariables.render({values: shape, key: &quot;render&quot;})
                } catch(err) {
                    console.warn(err)
                    return -1
                }
            }

            computeValue().then(result =&gt; {
                this.updateDisplayData(result)
            })
        }
    }
    
    /**
     * Zooms the camera to fit target bounds on the screen.
     * @param {array} bounds - An array of some sort...this comment should be updated.
     */ 
    zoomCameraToFit(bounds){

        this.controls.reset()
        this.camera.position.x = 0
        this.camera.position.y = -5*Math.max(...bounds[1])
        this.camera.position.z = 5*Math.max(...bounds[1])

        /*initializes grid at scale if object loaded is already 
            zoomed out farther than initial grid tier*/ 
        this.gridScale = Math.pow(5, this.baseLog(this.dist3D(this.camera.position),5))    
        // Creates initial grid plane
        this.resizeGrid()
    }

    /**
     * Redraws the grid with gridscale update value
     */ 
    resizeGrid () {
        this.scene.remove(this.plane)
        var planeGeometry = new THREE.PlaneBufferGeometry( this.gridScale, this.gridScale, 10, 10)
        var planeMaterial = new THREE.MeshStandardMaterial( { color: 0xffffff} )
        planeMaterial.wireframe = true
        planeMaterial.transparent = true 
        planeMaterial.opacity = 0.2
        /** 
         * The grid which displays under the part.
         * @type {object}
         */
        this.plane = new THREE.Mesh( planeGeometry, planeMaterial )
        this.plane.receiveShadow = true
        this.scene.add( this.plane )   
    }

    /**
     * Clears the display and writes a threejs geometry to it.
     * @param {object} threejsGeometry - A threejs geometry to write to the display.
     */ 
    updateDisplayData(threejsGeometry){
        // Delete any previous dataset in the window.
        for (const { mesh } of this.datasets) {
            this.scene.remove(mesh)
        }
        
        // Build new datasets from the written data, and display them.
        this.datasets = []
        
        /** 
         * Does this even need to be a global object?
         * @type {object}
         */
        this.threeMaterial = new THREE.MeshStandardMaterial({
            color: 0x5f6670,
            roughness: 0.65,
            metalness: 0.40,   
            wireframe: this.wireDisplay
        })

        const walk = (geometry) =&gt; {
            if (geometry.assembly) {
                geometry.assembly.forEach(walk)
            } else if (geometry.threejsSegments) {
                const segments = geometry.threejsSegments
                const dataset = {}
                const threejsGeometry = new THREE.Geometry()
                for (const [[aX, aY, aZ], [bX, bY, bZ]] of segments) {
                    threejsGeometry.vertices.push(new THREE.Vector3(aX, aY, aZ), new THREE.Vector3(bX, bY, bZ))
                }
                dataset.mesh = new THREE.LineSegments(threejsGeometry, this.threeMaterial)
                this.scene.add(dataset.mesh)
                this.datasets.push(dataset)
            } else if (geometry.threejsSolid) {
                const { positions, normals } = geometry.threejsSolid
                const dataset = {}
                const threejsGeometry = new THREE.BufferGeometry()
                threejsGeometry.addAttribute(&apos;position&apos;, new THREE.Float32BufferAttribute(positions, 3))
                threejsGeometry.addAttribute(&apos;normal&apos;, new THREE.Float32BufferAttribute(normals, 3))
                dataset.mesh = new THREE.Mesh(threejsGeometry, this.threeMaterial)
                this.scene.add(dataset.mesh)
                this.datasets.push(dataset)
            } else if (geometry.threejsSurface) {
                const { positions, normals } = geometry.threejsSurface
                const dataset = {}
                const threejsGeometry = new THREE.BufferGeometry()
                threejsGeometry.addAttribute(&apos;position&apos;, new THREE.Float32BufferAttribute(positions, 3))
                threejsGeometry.addAttribute(&apos;normal&apos;, new THREE.Float32BufferAttribute(normals, 3))
                dataset.mesh = new THREE.Mesh(threejsGeometry, this.threeMaterial)
                this.scene.add(dataset.mesh)
                this.datasets.push(dataset)
            }
        }
        walk(threejsGeometry)
    }
    
    /**
     * Handles resizing the 3D viewer when the window resizes.
     */ 
    onWindowResize() {
        this.camera.aspect = this.targetDiv.clientWidth / (this.targetDiv.clientHeight)
        this.camera.updateProjectionMatrix()
        this.controls.handleResize()
        this.renderer.setSize(this.targetDiv.clientWidth, this.targetDiv.clientHeight)
    }
    
    /**
     * Runs regularly to update the display.
     */ 
    render() {
        this.renderer.render( this.scene, this.camera )
    }
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
